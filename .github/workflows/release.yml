name: Release

on:
  push:
    branches: [main]
  workflow_dispatch:

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}

env:
  NODE_OPTIONS: "--max-old-space-size=4096"

jobs:
  # ============ JOB 1: Build and Publish ============
  release:
    name: Release
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write
      id-token: write
    outputs:
      published: ${{ steps.check-publish.outputs.published }}
      version: ${{ steps.check-publish.outputs.version }}

    steps:
      - uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4

      - uses: actions/setup-node@39370e3970a6d050c480ffad4ff0ed4d3fdee5af # v4
        with:
          node-version: "20"
          registry-url: "https://registry.npmjs.org/"

      - run: corepack enable
      - run: corepack prepare yarn@4.12.0 --activate
      - run: yarn install --immutable

      - name: Build packages
        run: |
          yarn build:sdk
          yarn cli:build

      - name: Create Release Pull Request or Publish
        id: changesets
        uses: changesets/action@c8bada60c408975afd1a20b3db81d6eee6789308 # v1
        with:
          version: yarn changeset:version
          publish: yarn changeset:publish
          title: "chore: version packages"
          commit: "chore: version packages"
        env:
          GITHUB_TOKEN: ${{ secrets.RELEASE_TOKEN }}
          NPM_TOKEN: ${{ secrets.NPM_TOKEN }}
          NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}
          YARN_NPM_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}

      - name: Check if published
        id: check-publish
        run: |
          # Get version from local package.json
          LOCAL_VERSION=$(node -p "require('./packages/sdk/package.json').version")

          # Get latest version from npm (empty if not published yet)
          NPM_VERSION=$(npm view @vultisig/sdk version 2>/dev/null || echo "")

          echo "Local version: $LOCAL_VERSION"
          echo "NPM version: $NPM_VERSION"

          if [ "$LOCAL_VERSION" == "$NPM_VERSION" ]; then
            echo "published=true" >> $GITHUB_OUTPUT
            echo "version=$LOCAL_VERSION" >> $GITHUB_OUTPUT
          else
            echo "published=false" >> $GITHUB_OUTPUT
          fi

  # ============ JOB 2: Tag + GitHub Release (needs release) ============
  tag-and-release:
    name: Tag & GitHub Release
    needs: release
    if: needs.release.outputs.published == 'true'
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4

      - name: Create and push tag
        run: |
          if git rev-parse "v${{ needs.release.outputs.version }}" >/dev/null 2>&1; then
            echo "Tag v${{ needs.release.outputs.version }} already exists, skipping tag creation"
            exit 0
          fi
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git tag -a "v${{ needs.release.outputs.version }}" -m "Release v${{ needs.release.outputs.version }}"
          git push origin "v${{ needs.release.outputs.version }}"

      - name: Create GitHub Release
        uses: softprops/action-gh-release@da05d552573ad5aba039eaac05058a918a7bf631 # v2
        with:
          tag_name: v${{ needs.release.outputs.version }}
          name: v${{ needs.release.outputs.version }}
          generate_release_notes: true
          prerelease: ${{ contains(needs.release.outputs.version, 'alpha') || contains(needs.release.outputs.version, 'beta') || contains(needs.release.outputs.version, 'rc') }}

  # ============ JOB 3: Deploy Vercel (needs release, parallel with others) ============
  deploy-vercel:
    name: Deploy Vercel
    needs: release
    if: needs.release.outputs.published == 'true'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4

      - uses: actions/setup-node@39370e3970a6d050c480ffad4ff0ed4d3fdee5af # v4
        with:
          node-version: "20"

      - run: corepack enable
      - run: corepack prepare yarn@4.12.0 --activate
      - run: yarn install --immutable
      - run: yarn build:sdk

      - run: npm install -g vercel

      - name: Build & Deploy
        working-directory: ./examples/browser
        run: |
          yarn build
          cp vercel.json dist/
          vercel deploy dist --prod --token=${{ secrets.VERCEL_TOKEN }}
        env:
          VERCEL_ORG_ID: ${{ secrets.VERCEL_ORG_ID }}
          VERCEL_PROJECT_ID: ${{ secrets.VERCEL_PROJECT_ID }}

  # ============ JOB 4: Sync Docs (needs release, parallel with others) ============
  sync-docs:
    name: Sync Docs
    needs: release
    if: needs.release.outputs.published == 'true'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4

      - uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4
        with:
          repository: vultisig/docs
          token: ${{ secrets.DOCS_REPO_PAT }}
          path: docs-repo

      - name: Sync and push
        run: |
          mkdir -p docs-repo/developer-docs/vultisig-sdk
          cp packages/sdk/README.md docs-repo/developer-docs/vultisig-sdk/README.md
          cp docs/SDK-USERS-GUIDE.md docs-repo/developer-docs/vultisig-sdk/SDK-USERS-GUIDE.md
          cp clients/cli/README.md docs-repo/developer-docs/vultisig-sdk/CLI.md
          cd docs-repo
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add developer-docs/vultisig-sdk/
          git diff --staged --quiet || git commit -m "docs: sync vultisig-sdk v${{ needs.release.outputs.version }}"
          git push

  # ============ JOB 5: Discord Notify (waits for all parallel jobs) ============
  notify:
    name: Discord Notify
    needs: [release, tag-and-release, deploy-vercel, sync-docs]
    if: always() && needs.release.outputs.published == 'true'
    runs-on: ubuntu-latest
    steps:
      - name: Notify Discord
        env:
          DISCORD_WEBHOOK: ${{ secrets.DISCORD_WEBHOOK_URL }}
          VERSION: ${{ needs.release.outputs.version }}
        run: |
          curl -X POST "$DISCORD_WEBHOOK" \
            -H "Content-Type: application/json" \
            -d @- << EOF
          {
            "embeds": [{
              "title": "VultisigSDK v${VERSION} Released!",
              "color": 5814783,
              "description": "A new version of VultisigSDK has been published to npm.",
              "fields": [
                {
                  "name": "Packages",
                  "value": "[@vultisig/sdk](https://www.npmjs.com/package/@vultisig/sdk)\n[@vultisig/cli](https://www.npmjs.com/package/@vultisig/cli)",
                  "inline": true
                },
                {
                  "name": "Version",
                  "value": "v${VERSION}",
                  "inline": true
                },
                {
                  "name": "Installation",
                  "value": "\`\`\`bash\nnpm install @vultisig/sdk@${VERSION}\n\`\`\`"
                },
                {
                  "name": "Links",
                  "value": "[Documentation](https://vultisig.github.io/vultisig-sdk/) | [Changelog](https://github.com/vultisig/vultisig-sdk/releases) | [GitHub](https://github.com/vultisig/vultisig-sdk)"
                }
              ],
              "footer": {
                "text": "VultisigSDK - Multi-party computation wallet SDK"
              }
            }]
          }
          EOF
