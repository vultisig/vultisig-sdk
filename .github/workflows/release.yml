name: Release

on:
  push:
    branches:
      - main

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

env:
  NODE_OPTIONS: "--max-old-space-size=4096"

jobs:
  release:
    name: Release
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write
      id-token: write

    steps:
      - name: Checkout
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4

      - name: Setup Node.js
        uses: actions/setup-node@39370e3970a6d050c480ffad4ff0ed4d3fdee5af # v4
        with:
          node-version: "20"
          registry-url: "https://registry.npmjs.org/"

      - name: Enable Corepack
        run: corepack enable

      - name: Prepare Yarn
        run: corepack prepare yarn@4.9.1 --activate

      - name: Install dependencies
        run: yarn install --immutable

      - name: Build packages
        run: |
          yarn build:sdk
          yarn cli:build

      - name: Create Release Pull Request or Publish
        id: changesets
        uses: changesets/action@c8bada60c408975afd1a20b3db81d6eee6789308 # v1
        with:
          version: yarn changeset:version
          publish: yarn changeset:publish
          title: "chore: version packages"
          commit: "chore: version packages"
        env:
          GITHUB_TOKEN: ${{ secrets.RELEASE_TOKEN }}
          NPM_TOKEN: ${{ secrets.NPM_TOKEN }}
          NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}
          YARN_NPM_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}

      - name: Enable Auto-Merge on Version PR
        if: steps.changesets.outputs.pullRequestNumber
        run: gh pr merge ${{ steps.changesets.outputs.pullRequestNumber }} --auto --merge
        env:
          GH_TOKEN: ${{ secrets.RELEASE_TOKEN }}

      - name: Notify Discord
        if: always()
        env:
          DISCORD_WEBHOOK: ${{ secrets.DISCORD_WEBHOOK_URL }}
        run: |
          # Get version from package.json
          VERSION=$(jq -r .version packages/sdk/package.json)

          # Check if this version exists on npm (just published)
          PUBLISHED=$(npm view @vultisig/sdk@$VERSION version 2>/dev/null || echo "")

          if [ "$PUBLISHED" = "$VERSION" ]; then
            curl -X POST "$DISCORD_WEBHOOK" \
              -H "Content-Type: application/json" \
              -d "{\"embeds\":[{\"title\":\"VultisigSDK v${VERSION} Released!\",\"color\":5814783,\"description\":\"A new version of VultisigSDK has been published to npm.\",\"fields\":[{\"name\":\"Packages\",\"value\":\"[@vultisig/sdk](https://www.npmjs.com/package/@vultisig/sdk)\\n[@vultisig/cli](https://www.npmjs.com/package/@vultisig/cli)\",\"inline\":true},{\"name\":\"Version\",\"value\":\"v${VERSION}\",\"inline\":true},{\"name\":\"Installation\",\"value\":\"\`\`\`bash\\nnpm install @vultisig/sdk@${VERSION}\\n\`\`\`\"},{\"name\":\"Links\",\"value\":\"[Documentation](https://vultisig.github.io/vultisig-sdk/) | [Changelog](https://github.com/vultisig/vultisig-sdk/releases) | [GitHub](https://github.com/vultisig/vultisig-sdk)\"}],\"footer\":{\"text\":\"VultisigSDK - Multi-party computation wallet SDK\"}}]}"
          fi
