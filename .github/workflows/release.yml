name: Release

on:
  push:
    branches: [main]
  workflow_dispatch:

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}

env:
  NODE_OPTIONS: "--max-old-space-size=4096"

jobs:
  # ============ JOB 0: Check if release workflow should run ============
  check:
    name: Check Release Conditions
    runs-on: ubuntu-latest
    outputs:
      should_release: ${{ steps.check.outputs.should_release }}
    steps:
      - uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4

      - name: Check for changesets or release commit
        id: check
        run: |
          # Check if this is a release PR merge (commit message starts with "chore: version packages")
          COMMIT_MSG=$(git log -1 --pretty=%B)
          if [[ "$COMMIT_MSG" == "chore: version packages"* ]]; then
            echo "Release PR merge detected"
            echo "should_release=true" >> $GITHUB_OUTPUT
            exit 0
          fi

          # Check if there are any changesets (excluding README.md)
          CHANGESETS=$(find .changeset -name "*.md" ! -name "README.md" 2>/dev/null | head -1)
          if [ -n "$CHANGESETS" ]; then
            echo "Changesets found"
            echo "should_release=true" >> $GITHUB_OUTPUT
            exit 0
          fi

          # Check if manually triggered
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            echo "Manual trigger detected"
            echo "should_release=true" >> $GITHUB_OUTPUT
            exit 0
          fi

          echo "No changesets and not a release commit, skipping"
          echo "should_release=false" >> $GITHUB_OUTPUT

  # ============ JOB 1: Build and Publish ============
  release:
    name: Release
    needs: check
    if: needs.check.outputs.should_release == 'true'
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write
      id-token: write
    outputs:
      published: ${{ steps.changesets.outputs.published }}
      publishedPackages: ${{ steps.changesets.outputs.publishedPackages }}

    steps:
      - uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4

      - uses: actions/setup-node@39370e3970a6d050c480ffad4ff0ed4d3fdee5af # v4
        with:
          node-version: "20"
          registry-url: "https://registry.npmjs.org/"

      - run: corepack enable
      - run: corepack prepare yarn@4.12.0 --activate
      - run: yarn install --immutable

      - name: Build packages
        run: |
          yarn build:sdk
          yarn cli:build

      - name: Upload SDK build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: sdk-dist
          path: packages/sdk/dist
          retention-days: 1

      - name: Create Release Pull Request or Publish
        id: changesets
        uses: changesets/action@c8bada60c408975afd1a20b3db81d6eee6789308 # v1
        with:
          version: yarn changeset:version
          publish: yarn changeset:publish
          title: "chore: version packages"
          commit: "chore: version packages"
        env:
          GITHUB_TOKEN: ${{ secrets.RELEASE_TOKEN }}
          NPM_TOKEN: ${{ secrets.NPM_TOKEN }}
          NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}
          YARN_NPM_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}

  # ============ JOB 2: Tag + GitHub Release (needs release) ============
  tag-and-release:
    name: Tag & GitHub Release
    needs: release
    if: needs.release.outputs.published == 'true'
    runs-on: ubuntu-latest
    permissions:
      contents: write
    env:
      VERSION: ${{ fromJson(needs.release.outputs.publishedPackages)[0].version }}
    steps:
      - uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4

      - name: Create and push tag
        run: |
          if git rev-parse "v$VERSION" >/dev/null 2>&1; then
            echo "Tag v$VERSION already exists, skipping tag creation"
            exit 0
          fi
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git tag -a "v$VERSION" -m "Release v$VERSION"
          git push origin "v$VERSION"

      - name: Create GitHub Release
        uses: softprops/action-gh-release@da05d552573ad5aba039eaac05058a918a7bf631 # v2
        with:
          tag_name: v${{ env.VERSION }}
          name: v${{ env.VERSION }}
          generate_release_notes: true
          prerelease: ${{ contains(env.VERSION, 'alpha') || contains(env.VERSION, 'beta') || contains(env.VERSION, 'rc') }}

  # ============ JOB 3: Deploy Vercel (needs release, parallel with others) ============
  deploy-vercel:
    name: Deploy Vercel
    needs: release
    if: needs.release.outputs.published == 'true'
    runs-on: ubuntu-latest
    outputs:
      url: ${{ steps.deploy.outputs.url }}
    steps:
      - uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4

      - uses: actions/setup-node@39370e3970a6d050c480ffad4ff0ed4d3fdee5af # v4
        with:
          node-version: "20"

      - name: Download SDK build artifacts
        uses: actions/download-artifact@v4
        with:
          name: sdk-dist
          path: packages/sdk/dist

      - run: corepack enable
      - run: corepack prepare yarn@4.12.0 --activate
      - run: yarn install --immutable

      - run: npm install -g vercel

      - name: Build & Deploy
        id: deploy
        working-directory: ./examples/browser
        run: |
          yarn build
          cp vercel.json dist/
          DEPLOY_URL=$(vercel deploy dist --prod --token=${{ secrets.VERCEL_TOKEN }})
          echo "url=$DEPLOY_URL" >> $GITHUB_OUTPUT
        env:
          VERCEL_ORG_ID: ${{ secrets.VERCEL_ORG_ID }}
          VERCEL_PROJECT_ID: ${{ secrets.VERCEL_PROJECT_ID }}

  # ============ JOB 4: Sync Docs (needs release, parallel with others) ============
  sync-docs:
    name: Sync Docs
    needs: release
    if: needs.release.outputs.published == 'true'
    runs-on: ubuntu-latest
    env:
      VERSION: ${{ fromJson(needs.release.outputs.publishedPackages)[0].version }}
    steps:
      - uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4

      - uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4
        with:
          repository: vultisig/docs
          token: ${{ secrets.DOCS_REPO_PAT }}
          path: docs-repo

      - name: Sync and push
        run: |
          mkdir -p docs-repo/developer-docs/vultisig-sdk
          cp packages/sdk/README.md docs-repo/developer-docs/vultisig-sdk/README.md
          cp docs/SDK-USERS-GUIDE.md docs-repo/developer-docs/vultisig-sdk/SDK-USERS-GUIDE.md
          cp clients/cli/README.md docs-repo/developer-docs/vultisig-sdk/CLI.md
          cd docs-repo
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add developer-docs/vultisig-sdk/
          git diff --staged --quiet || git commit -m "docs: sync vultisig-sdk v$VERSION"
          git push

  # ============ JOB 5: Discord Notify (waits for all parallel jobs) ============
  notify:
    name: Discord Notify
    needs: [release, tag-and-release, deploy-vercel, sync-docs]
    if: always() && needs.release.outputs.published == 'true'
    runs-on: ubuntu-latest
    steps:
      - name: Notify Discord
        env:
          DISCORD_WEBHOOK: ${{ secrets.DISCORD_WEBHOOK_URL }}
          VERSION: ${{ fromJson(needs.release.outputs.publishedPackages)[0].version }}
          BROWSER_URL: ${{ needs.deploy-vercel.outputs.url }}
        run: |
          curl -X POST "$DISCORD_WEBHOOK" \
            -H "Content-Type: application/json" \
            -d @- << EOF
          {
            "embeds": [{
              "title": "VultisigSDK v${VERSION} Released!",
              "color": 5814783,
              "description": "A new version of VultisigSDK has been published to npm.",
              "fields": [
                {
                  "name": "Packages",
                  "value": "[@vultisig/sdk](https://www.npmjs.com/package/@vultisig/sdk)\n[@vultisig/cli](https://www.npmjs.com/package/@vultisig/cli)",
                  "inline": true
                },
                {
                  "name": "Version",
                  "value": "v${VERSION}",
                  "inline": true
                },
                {
                  "name": "Installation",
                  "value": "\`\`\`bash\nnpm install @vultisig/sdk@${VERSION}\n\`\`\`"
                },
                {
                  "name": "Links",
                  "value": "[Documentation](https://vultisig.github.io/vultisig-sdk/) | [Browser Demo](https://browser-six-sandy.vercel.app/) | [Changelog](https://github.com/vultisig/vultisig-sdk/releases) | [GitHub](https://github.com/vultisig/vultisig-sdk)"
                }
              ],
              "footer": {
                "text": "VultisigSDK - Multi-party computation wallet SDK"
              }
            }]
          }
          EOF
