name: Release

on:
  push:
    branches: [main]
  workflow_dispatch:
    inputs:
      force_release:
        description: "Force release even without version commit"
        required: false
        type: boolean
        default: false

concurrency:
  group: release-${{ github.workflow }}-${{ github.ref }}

env:
  NODE_OPTIONS: "--max-old-space-size=4096"

jobs:
  # ============ JOB 1: Build Packages ============
  build:
    name: Build Packages
    runs-on: ubuntu-latest
    # Only run on version PR merge or manual force trigger
    if: |
      contains(github.event.head_commit.message, 'chore: version packages') ||
      github.event.inputs.force_release == 'true'
    outputs:
      version: ${{ steps.version.outputs.version }}
      should_publish: ${{ steps.version.outputs.should_publish }}
    steps:
      - uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4

      - uses: actions/setup-node@49933ea5288caeca8642d1e84afbd3f7d6820020 # v4
        with:
          node-version: "20"
          cache: "yarn"

      - run: corepack enable
      - run: corepack prepare yarn@4.12.0 --activate
      - run: yarn install --immutable

      - name: Build SDK and CLI
        run: |
          yarn build:sdk
          yarn cli:build

      - name: Get version and check if new
        id: version
        run: |
          LOCAL_VERSION=$(node -p "require('./packages/sdk/package.json').version")
          echo "version=$LOCAL_VERSION" >> $GITHUB_OUTPUT

          # Check if this version is already published on NPM
          NPM_VERSION=$(npm view @vultisig/sdk version 2>/dev/null || echo "0.0.0")

          if [ "$LOCAL_VERSION" = "$NPM_VERSION" ]; then
            echo "Version $LOCAL_VERSION already published, skipping"
            echo "should_publish=false" >> $GITHUB_OUTPUT
          else
            echo "New version $LOCAL_VERSION (npm has $NPM_VERSION)"
            echo "should_publish=true" >> $GITHUB_OUTPUT
          fi

      - name: Upload SDK dist
        uses: actions/upload-artifact@v4
        with:
          name: sdk-dist
          path: packages/sdk/dist
          retention-days: 1

      - name: Upload CLI dist
        uses: actions/upload-artifact@v4
        with:
          name: cli-dist
          path: clients/cli/dist
          retention-days: 1

  # ============ JOB 2: Run Tests (parallel with build) ============
  test:
    name: Run Tests
    runs-on: ubuntu-latest
    # Same condition as build
    if: |
      contains(github.event.head_commit.message, 'chore: version packages') ||
      github.event.inputs.force_release == 'true'
    steps:
      - uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4

      - uses: actions/setup-node@49933ea5288caeca8642d1e84afbd3f7d6820020 # v4
        with:
          node-version: "20"
          cache: "yarn"

      - run: corepack enable
      - run: corepack prepare yarn@4.12.0 --activate
      - run: yarn install --immutable

      - name: Build SDK (required for tests)
        run: yarn build:sdk

      - name: Run unit tests
        run: yarn test

      - name: Run lint and typecheck
        run: |
          yarn lint
          yarn typecheck

  # ============ JOB 3: Publish to NPM ============
  publish:
    name: Publish to NPM
    needs: [build, test]
    if: needs.build.outputs.should_publish == 'true'
    runs-on: ubuntu-latest
    permissions:
      id-token: write
    steps:
      - uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4

      - uses: actions/setup-node@49933ea5288caeca8642d1e84afbd3f7d6820020 # v4
        with:
          node-version: "20"
          registry-url: "https://registry.npmjs.org/"
          cache: "yarn"

      - run: corepack enable
      - run: corepack prepare yarn@4.12.0 --activate
      - run: yarn install --immutable

      - name: Download SDK dist
        uses: actions/download-artifact@v4
        with:
          name: sdk-dist
          path: packages/sdk/dist

      - name: Download CLI dist
        uses: actions/download-artifact@v4
        with:
          name: cli-dist
          path: clients/cli/dist

      - name: Publish to NPM
        run: yarn changeset:publish
        env:
          NPM_TOKEN: ${{ secrets.NPM_TOKEN }}
          NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}
          YARN_NPM_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}

  # ============ JOB 4: Tag + GitHub Release ============
  tag-and-release:
    name: Tag & GitHub Release
    needs: [build, test]
    if: needs.build.outputs.should_publish == 'true'
    runs-on: ubuntu-latest
    permissions:
      contents: write
    env:
      VERSION: ${{ needs.build.outputs.version }}
    steps:
      - uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4

      - name: Create and push tag
        run: |
          if git rev-parse "v$VERSION" >/dev/null 2>&1; then
            echo "Tag v$VERSION already exists, skipping tag creation"
            exit 0
          fi
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git tag -a "v$VERSION" -m "Release v$VERSION"
          git push origin "v$VERSION"

      - name: Create GitHub Release
        uses: softprops/action-gh-release@da05d552573ad5aba039eaac05058a918a7bf631 # v2
        with:
          tag_name: v${{ env.VERSION }}
          name: v${{ env.VERSION }}
          generate_release_notes: true
          prerelease: ${{ contains(env.VERSION, 'alpha') || contains(env.VERSION, 'beta') || contains(env.VERSION, 'rc') }}

  # ============ JOB 5: Deploy Vercel ============
  deploy-vercel:
    name: Deploy Vercel
    needs: [build, test]
    runs-on: ubuntu-latest
    outputs:
      url: ${{ steps.deploy.outputs.url }}
    steps:
      - uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4

      - uses: actions/setup-node@49933ea5288caeca8642d1e84afbd3f7d6820020 # v4
        with:
          node-version: "20"
          cache: "yarn"

      - name: Download SDK build artifacts
        uses: actions/download-artifact@v4
        with:
          name: sdk-dist
          path: packages/sdk/dist

      - run: corepack enable
      - run: corepack prepare yarn@4.12.0 --activate
      - run: yarn install --immutable

      - run: npm install -g vercel

      - name: Build & Deploy
        id: deploy
        working-directory: ./examples/browser
        run: |
          yarn build
          cp vercel.json dist/
          DEPLOY_URL=$(vercel deploy dist --prod --token=${{ secrets.VERCEL_TOKEN }})
          echo "url=$DEPLOY_URL" >> $GITHUB_OUTPUT
        env:
          VERCEL_ORG_ID: ${{ secrets.VERCEL_ORG_ID }}
          VERCEL_PROJECT_ID: ${{ secrets.VERCEL_PROJECT_ID }}

  # ============ JOB 6: Sync Docs ============
  sync-docs:
    name: Sync Docs
    needs: [build, test]
    runs-on: ubuntu-latest
    env:
      VERSION: ${{ needs.build.outputs.version }}
    steps:
      - uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4

      - uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4
        with:
          repository: vultisig/docs
          token: ${{ secrets.DOCS_REPO_PAT }}
          path: docs-repo

      - name: Sync and push
        run: |
          mkdir -p docs-repo/developer-docs/vultisig-sdk
          cp packages/sdk/README.md docs-repo/developer-docs/vultisig-sdk/README.md
          cp docs/SDK-USERS-GUIDE.md docs-repo/developer-docs/vultisig-sdk/SDK-USERS-GUIDE.md
          cp clients/cli/README.md docs-repo/developer-docs/vultisig-sdk/CLI.md
          cd docs-repo
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add developer-docs/vultisig-sdk/
          git diff --staged --quiet || git commit -m "docs: sync vultisig-sdk v$VERSION"
          git push

  # ============ JOB 7: Discord Notify ============
  notify:
    name: Discord Notify
    needs: [build, test, publish, tag-and-release, deploy-vercel, sync-docs]
    if: always() && needs.build.outputs.should_publish == 'true'
    runs-on: ubuntu-latest
    steps:
      - name: Notify Discord
        env:
          DISCORD_WEBHOOK: ${{ secrets.DISCORD_WEBHOOK_URL }}
          VERSION: ${{ needs.build.outputs.version }}
          BROWSER_URL: ${{ needs.deploy-vercel.outputs.url }}
        run: |
          curl -X POST "$DISCORD_WEBHOOK" \
            -H "Content-Type: application/json" \
            -d @- << EOF
          {
            "embeds": [{
              "title": "VultisigSDK v${VERSION} Released!",
              "color": 5814783,
              "description": "A new version of VultisigSDK has been published to npm.",
              "fields": [
                {
                  "name": "Packages",
                  "value": "[@vultisig/sdk](https://www.npmjs.com/package/@vultisig/sdk)\n[@vultisig/cli](https://www.npmjs.com/package/@vultisig/cli)",
                  "inline": true
                },
                {
                  "name": "Version",
                  "value": "v${VERSION}",
                  "inline": true
                },
                {
                  "name": "Installation",
                  "value": "\`\`\`bash\nnpm install @vultisig/sdk@${VERSION}\n\`\`\`"
                },
                {
                  "name": "Links",
                  "value": "[Documentation](https://docs.vultisig.com/developer-docs/vultisig-sdk) | [Browser Demo](https://browser-six-sandy.vercel.app/) | [Changelog](https://github.com/vultisig/vultisig-sdk/releases) | [GitHub](https://github.com/vultisig/vultisig-sdk)"
                }
              ],
              "footer": {
                "text": "VultisigSDK - Multi-party computation wallet SDK"
              }
            }]
          }
          EOF
