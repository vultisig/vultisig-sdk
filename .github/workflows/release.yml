name: Release

on:
  push:
    branches: [main]
  workflow_dispatch:
    inputs:
      force_release:
        description: "Force release even without version commit"
        required: false
        type: boolean
        default: false

concurrency:
  group: release-${{ github.workflow }}-${{ github.ref }}

env:
  NODE_OPTIONS: "--max-old-space-size=4096"

jobs:
  # ============ JOB 1: Build Packages ============
  build:
    name: Build Packages
    runs-on: ubuntu-latest
    # Only run on version PR merge or manual force trigger
    if: |
      contains(github.event.head_commit.message, 'chore: version packages') ||
      github.event.inputs.force_release == 'true'
    outputs:
      version: ${{ steps.version.outputs.version }}
      should_publish: ${{ steps.version.outputs.should_publish }}
    steps:
      - uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4

      - uses: actions/setup-node@49933ea5288caeca8642d1e84afbd3f7d6820020 # v4
        with:
          node-version: "20"
          cache: "yarn"

      - run: corepack enable
      - run: corepack prepare yarn@4.12.0 --activate
      - run: yarn install --immutable

      - name: Build all packages
        run: |
          yarn build:all
          yarn cli:build

      - name: Get version and check if new
        id: version
        run: |
          LOCAL_VERSION=$(node -p "require('./packages/sdk/package.json').version")
          echo "version=$LOCAL_VERSION" >> $GITHUB_OUTPUT

          # Check if any package still needs publishing
          SDK_NPM=$(npm view @vultisig/sdk version 2>/dev/null || echo "0.0.0")
          RUJIRA_NPM=$(npm view @vultisig/rujira version 2>/dev/null || echo "0.0.0")
          RUJIRA_LOCAL=$(node -p "require('./packages/rujira/package.json').version")

          echo "SDK: local=$LOCAL_VERSION npm=$SDK_NPM"
          echo "Rujira: local=$RUJIRA_LOCAL npm=$RUJIRA_NPM"

          if [ "$LOCAL_VERSION" = "$SDK_NPM" ] && [ "$RUJIRA_LOCAL" = "$RUJIRA_NPM" ]; then
            echo "All packages already published, skipping"
            echo "should_publish=false" >> $GITHUB_OUTPUT
          else
            echo "Unpublished packages found, proceeding with publish"
            echo "should_publish=true" >> $GITHUB_OUTPUT
          fi

      - name: Upload SDK dist
        uses: actions/upload-artifact@v4
        with:
          name: sdk-dist
          path: packages/sdk/dist
          retention-days: 1

      - name: Upload CLI dist
        uses: actions/upload-artifact@v4
        with:
          name: cli-dist
          path: clients/cli/dist
          retention-days: 1

      - name: Upload rujira dist
        uses: actions/upload-artifact@v4
        with:
          name: rujira-dist
          path: packages/rujira/dist
          retention-days: 1

  # ============ JOB 2: Run Tests (parallel with build) ============
  test:
    name: Run Tests
    runs-on: ubuntu-latest
    # Same condition as build
    if: |
      contains(github.event.head_commit.message, 'chore: version packages') ||
      github.event.inputs.force_release == 'true'
    steps:
      - uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4

      - uses: actions/setup-node@49933ea5288caeca8642d1e84afbd3f7d6820020 # v4
        with:
          node-version: "20"
          cache: "yarn"

      - run: corepack enable
      - run: corepack prepare yarn@4.12.0 --activate
      - run: yarn install --immutable

      - name: Build packages (required for tests)
        run: yarn build:all

      - name: Run unit tests
        run: yarn test

      - name: Run rujira tests
        run: yarn test:rujira

      - name: Run lint and typecheck
        run: |
          yarn lint
          yarn typecheck

  # ============ JOB 3: Publish to NPM ============
  publish:
    name: Publish to NPM
    needs: [build, test]
    if: needs.build.outputs.should_publish == 'true'
    runs-on: ubuntu-latest
    permissions:
      id-token: write
    steps:
      - uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4

      - uses: actions/setup-node@49933ea5288caeca8642d1e84afbd3f7d6820020 # v4
        with:
          node-version: "20"
          registry-url: "https://registry.npmjs.org/"
          cache: "yarn"

      - run: corepack enable
      - run: corepack prepare yarn@4.12.0 --activate
      - run: yarn install --immutable

      - name: Download SDK dist
        uses: actions/download-artifact@v4
        with:
          name: sdk-dist
          path: packages/sdk/dist

      - name: Download CLI dist
        uses: actions/download-artifact@v4
        with:
          name: cli-dist
          path: clients/cli/dist

      - name: Download rujira dist
        uses: actions/download-artifact@v4
        with:
          name: rujira-dist
          path: packages/rujira/dist

      - name: Publish to NPM
        run: yarn changeset:publish
        env:
          NPM_TOKEN: ${{ secrets.NPM_TOKEN }}
          NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}
          YARN_NPM_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}

  # ============ JOB 4: Tag + GitHub Release ============
  tag-and-release:
    name: Tag & GitHub Release
    needs: [build, test]
    if: needs.build.outputs.should_publish == 'true'
    runs-on: ubuntu-latest
    permissions:
      contents: write
    env:
      VERSION: ${{ needs.build.outputs.version }}
    steps:
      - uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4

      - name: Create and push tag
        run: |
          if git rev-parse "v$VERSION" >/dev/null 2>&1; then
            echo "Tag v$VERSION already exists, skipping tag creation"
            exit 0
          fi
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git tag -a "v$VERSION" -m "Release v$VERSION"
          git push origin "v$VERSION"

      - name: Create GitHub Release
        uses: softprops/action-gh-release@da05d552573ad5aba039eaac05058a918a7bf631 # v2
        with:
          tag_name: v${{ env.VERSION }}
          name: v${{ env.VERSION }}
          generate_release_notes: true
          prerelease: ${{ contains(env.VERSION, 'alpha') || contains(env.VERSION, 'beta') || contains(env.VERSION, 'rc') }}

  # ============ JOB 5: Deploy Vercel ============
  deploy-vercel:
    needs: [build, test]
    uses: ./.github/workflows/deploy-vercel.yml
    secrets: inherit

  # ============ JOB 6: Sync Docs ============
  sync-docs:
    needs: [build, test]
    uses: ./.github/workflows/sync-docs.yml
    with:
      version: ${{ needs.build.outputs.version }}
    secrets: inherit

  # ============ JOB 7: Sync Skills ============
  sync-skills:
    needs: [build, test]
    uses: ./.github/workflows/sync-skills.yml
    secrets: inherit

  # ============ JOB 8: Discord Notify ============
  notify:
    needs: [build, test, publish, tag-and-release, deploy-vercel, sync-docs, sync-skills]
    if: always() && needs.build.outputs.should_publish == 'true'
    uses: ./.github/workflows/notify-discord.yml
    with:
      version: ${{ needs.build.outputs.version }}
      browser_url: ${{ needs.deploy-vercel.outputs.url }}
    secrets: inherit
